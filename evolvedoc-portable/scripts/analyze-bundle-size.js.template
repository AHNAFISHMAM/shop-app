#!/usr/bin/env node

/**
 * Bundle Size Analyzer
 * 
 * Analyzes Vite build output and identifies large dependencies
 * and code splitting opportunities.
 * 
 * Usage: 
 *   1. Run: npm run build
 *   2. Run: node scripts/analyze-bundle-size.js
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const DIST_DIR = path.join(process.cwd(), 'dist')
const ASSETS_DIR = path.join(DIST_DIR, 'assets')

function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

function analyzeBundle() {
  if (!fs.existsSync(ASSETS_DIR)) {
    console.error('âŒ dist/assets/ directory not found. Run "npm run build" first.')
    process.exit(1)
  }
  
  const files = fs.readdirSync(ASSETS_DIR)
  const jsFiles = files.filter(f => f.endsWith('.js'))
  const cssFiles = files.filter(f => f.endsWith('.css'))
  
  const analysis = {
    js: [],
    css: [],
    total: {
      js: 0,
      css: 0,
      gzip: 0,
    },
  }
  
  jsFiles.forEach(file => {
    const filePath = path.join(ASSETS_DIR, file)
    const stats = fs.statSync(filePath)
    const size = stats.size
    
    // Estimate gzip size (typically 30-40% of original)
    const gzipSize = size * 0.35
    
    analysis.js.push({
      name: file,
      size,
      gzipSize,
      isVendor: file.includes('vendor'),
      isAdmin: file.includes('admin'),
    })
    
    analysis.total.js += size
    analysis.total.gzip += gzipSize
  })
  
  cssFiles.forEach(file => {
    const filePath = path.join(ASSETS_DIR, file)
    const stats = fs.statSync(filePath)
    const size = stats.size
    
    analysis.css.push({
      name: file,
      size,
    })
    
    analysis.total.css += size
  })
  
  // Sort by size
  analysis.js.sort((a, b) => b.size - a.size)
  analysis.css.sort((a, b) => b.size - a.size)
  
  return analysis
}

function generateReport(analysis) {
  let report = '# Bundle Size Analysis\n\n'
  
  report += `## Summary\n\n`
  report += `- **Total JS:** ${formatBytes(analysis.total.js)} (${formatBytes(analysis.total.gzip)} gzipped)\n`
  report += `- **Total CSS:** ${formatBytes(analysis.total.css)}\n`
  report += `- **Total Files:** ${analysis.js.length} JS, ${analysis.css.length} CSS\n\n`
  
  report += `## JavaScript Files\n\n`
  report += `| File | Size | Gzipped | Type |\n`
  report += `|------|------|---------|------|\n`
  
  analysis.js.forEach(file => {
    const type = file.isVendor ? 'Vendor' : file.isAdmin ? 'Admin' : 'App'
    report += `| ${file.name} | ${formatBytes(file.size)} | ${formatBytes(file.gzipSize)} | ${type} |\n`
  })
  
  report += `\n## CSS Files\n\n`
  report += `| File | Size |\n`
  report += `|------|------|\n`
  
  analysis.css.forEach(file => {
    report += `| ${file.name} | ${formatBytes(file.size)} |\n`
  })
  
  // Recommendations
  report += `\n## Recommendations\n\n`
  
  const largeFiles = analysis.js.filter(f => f.size > 200 * 1024) // > 200KB
  if (largeFiles.length > 0) {
    report += `### Large Files (>200KB)\n\n`
    largeFiles.forEach(file => {
      report += `- **${file.name}** (${formatBytes(file.size)})\n`
      if (!file.isVendor) {
        report += `  - Consider code splitting\n`
        report += `  - Check for unnecessary imports\n`
        report += `  - Use dynamic imports for heavy components\n`
      }
    })
    report += `\n`
  }
  
  const vendorSize = analysis.js
    .filter(f => f.isVendor)
    .reduce((sum, f) => sum + f.size, 0)
  
  if (vendorSize > 500 * 1024) {
    report += `### Vendor Bundle Optimization\n\n`
    report += `- Current vendor size: ${formatBytes(vendorSize)}\n`
    report += `- Consider splitting vendor chunks further\n`
    report += `- Review large dependencies\n`
    report += `- Check for duplicate dependencies\n\n`
  }
  
  const adminSize = analysis.js
    .filter(f => f.isAdmin)
    .reduce((sum, f) => sum + f.size, 0)
  
  if (adminSize > 100 * 1024) {
    report += `### Admin Bundle Optimization\n\n`
    report += `- Current admin size: ${formatBytes(adminSize)}\n`
    report += `- Admin code is properly separated âœ“\n`
    report += `- Consider lazy loading admin routes\n\n`
  }
  
  return report
}

// Main execution
console.log('ğŸ“Š Analyzing bundle size...')

const analysis = analyzeBundle()
const report = generateReport(analysis)

const reportPath = path.join(process.cwd(), 'bundle-analysis.md')
fs.writeFileSync(reportPath, report)

console.log('âœ… Analysis complete!')
console.log(`ğŸ“ Report written to ${reportPath}`)
console.log(`\n${report}`)

process.exit(0)

